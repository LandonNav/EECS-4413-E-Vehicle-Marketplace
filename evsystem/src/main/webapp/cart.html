<!DOCTYPE html>
<!--Author: Rucheng Yao, Description: Cart page for EV System-->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cart</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
  <header>
    <h1>Your Cart</h1> <!-- Page heading -->
    <nav>
      <a href="signin.html">Sign In</a>
      <a href="register.html">Register</a>
      <a href="catalog.html">Catalog</a>
      <a href="calculator.html">Loan Calculator</a>
      <a href="chatbot.html">Chatbot</a>
    </nav>
    <div id="user-controls" style="margin:10px 0;">
      <button id="signoutBtn" style="display:none;">Sign Out</button>
      <span id="userStatus"></span>
    </div>
  </header>
  <div class="container">
    <table id="cartTable" border="1">
      <tr>
        <th>ID</th>
        <th>Model</th>
        <th>Type</th>
        <th>Price</th>
        <th>Action</th> <!-- Remove from cart -->
      </tr>
      <!-- Cart items go here -->
    </table>
    <div id="total" style="margin-top:10px;">Total: $0</div> <!-- Total price -->
    <button id="checkoutBtn">Checkout</button> <!-- Checkout button -->
    <div id="error" style="color:red; margin-top:10px;"></div> <!-- Error message -->

    <!-- Loan Estimation Section -->
    <div style="margin-top:25px;">
      <h3>Estimate Loan</h3>
      <label>Down Payment: $<input type="number" id="downPayment" value="0" min="0"></label>
      <label style="margin-left:20px;">Loan Term (months): <input type="number" id="loanTerm" value="60" min="1"></label>
      <label style="margin-left:20px;">Annual Interest Rate (%): <input type="number" id="interestRate" value="5" min="0" step="0.01"></label>
      <button id="estimateLoanBtn">Estimate</button>
      <div id="loanResult" style="margin-top:10px; color:green;"></div> <!-- Loan estimation result -->
    </div>

    <!-- Payment Modal (hidden by default) -->
    <div id="paymentModal" style="display:none; position:fixed; top:20%; left:35%; background:#fff; border:1px solid #000; padding:24px; z-index:100;">
      <h3>Payment Information</h3>
      <form id="paymentForm">
      <label>Name on Card: <input type="text" id="cardName" required></label><br><br>
      <label>Card Number: <input type="text" id="cardNumber" required maxlength="19" pattern="[0-9 ]{13,19}"></label><br><br>
      <label>Expiry (MM/YY): <input type="text" id="cardExpiry" required pattern="[0-9]{2}/[0-9]{2}"></label><br><br>
      <label>CVC: <input type="password" id="cardCVC" required maxlength="4" pattern="[0-9]{3,4}"></label><br><br>
      <button type="submit">Pay Now</button>
      <button type="button" id="closePaymentModal" style="margin-left:16px;">Cancel</button>
      <div id="paymentError" style="color:red; margin-top:10px;"></div>
      </form>
    </div>

  </div>
  <footer>
    <p>Â© 2025 Electric Vehicle System</p> <!-- Footer -->
  </footer>
  <script>
    $(document).ready(function(){
      $.ajax({
      url: "/api/auth/status",
      type: 'GET',
      success: function(data) {
        if (data.signedIn) {
          $("#signoutBtn").show();
          $("#userStatus").text("Logged in");
          if (data.userId) {
            localStorage.setItem('userId', data.userId);
          }
        } else {
          $("#signoutBtn").hide();
          $("#userStatus").text("Not signed in");
        }
      }
    });

    $("#signoutBtn").click(function() {
      $.ajax({
        url: "/api/auth/signout",
        type: 'POST',
        success: function() {
          window.location.href = "signin.html";
        }
      });
    });
      loadCart(); // Load cart items

      // Fetch and display cart items
      function loadCart() {
        var userId = localStorage.getItem('userId') || 'guest';
        $.ajax({
        url: "/api/cart/view?userId=" + encodeURIComponent(userId),
        type: 'GET',
        success: function(result){
        var table = $("#cartTable");
        table.find("tr:gt(0)").remove(); // Clear old rows
        var total = 0;
        if (result.length === 0) {
          $("#total").text("Total: $0.00");
          return;
        }
        // Assume result is an array of vehicle IDs
        var countLoaded = 0;
        result.forEach(function(vehicleId){
        // For each vehicleId, fetch vehicle details
        $.ajax({
          url: "/api/vehicles/" + vehicleId,
          type: 'GET',
          success: function(vehicle){
            var row = $("<tr></tr>");
            row.append($("<td></td>").text(vehicle.id));
            row.append($("<td></td>").text(vehicle.model));
            row.append($("<td></td>").text(vehicle.type));
            row.append($("<td></td>").text(vehicle.price));
            var removeBtn = $("<button>Remove</button>");
            removeBtn.on("click", function(){
              removeFromCart(vehicle.id); // Remove action
            });
            row.append($("<td></td>").append(removeBtn));
            table.append(row);
            total += parseFloat(vehicle.price); // Add to total

            countLoaded++;
            // After all rows loaded, set total
            if(countLoaded === result.length) {
              $("#total").text("Total: $" + total.toFixed(2));
            }
          }
        });
      });
    },
    error: function(){
      $("#error").text("Failed to load cart items."); // Show error
    }
  });
}


      // Remove vehicle from cart
      function removeFromCart(vehicleId) {
      var userId = localStorage.getItem('userId') || 'guest';
      $.ajax({
        url: "/api/cart/remove",
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({userId: userId, vehicleId: vehicleId}),
        success: function(){
          loadCart(); // Refresh cart
          $("#error").text(''); // Clear error
        },
      error: function(){
        alert("Failed to remove from cart."); // Error remove
      }
    });
  }


      // Estimate Loan
      $("#estimateLoanBtn").on("click", function(){
        let total = parseFloat($("#total").text().replace(/[^0-9.]/g,"")) || 0;
        let down = parseFloat($("#downPayment").val()) || 0;
        let months = parseInt($("#loanTerm").val()) || 1;
        let rate = parseFloat($("#interestRate").val()) || 0;

        // Basic input validation
        if (down >= total) {
          $("#loanResult").css("color","red").text("Down payment must be less than total.");
          return;
        }
        if (months < 1) {
          $("#loanResult").css("color","red").text("Loan term must be at least 1 month.");
          return;
        }

        $.ajax({
          url: "/api/loan/estimate",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify({
            total: total,
            downPayment: down,
            loanTerm: months,
            annualInterestRate: rate
          }),
          success: function(response){
            // Expected: { monthlyPayment: number }
            $("#loanResult").css("color","green").html(
              "Estimated Monthly Payment: <b>$" + response.monthlyPayment.toFixed(2) + "</b>"
            );
          },
          error: function(){
            $("#loanResult").css("color","red").text("Failed to estimate loan.");
          }
        });
      });

      // Show payment modal on checkout click
      $("#checkoutBtn").on("click", function(){
        $("#paymentError").text("");
        $("#cardName").val("");
        $("#cardNumber").val("");
        $("#cardExpiry").val("");
        $("#cardCVC").val("");
        $("#paymentModal").show();
      });

      // Hide modal on cancel
      $("#closePaymentModal").on("click", function(){
        $("#paymentModal").hide();
      });

      // Handle payment submission
      $("#paymentForm").on("submit", function(e){
        e.preventDefault();

        // Simple front-end validation
        let cardName = $("#cardName").val().trim();
        let cardNumber = $("#cardNumber").val().replace(/\s+/g,'');
        let cardExpiry = $("#cardExpiry").val();
        let cardCVC = $("#cardCVC").val();

        if(!cardName || !cardNumber.match(/^[0-9]{13,19}$/) || !cardExpiry.match(/^[0-9]{2}\/[0-9]{2}$/) || !cardCVC.match(/^[0-9]{3,4}$/)){
          $("#paymentError").text("Please enter valid card details.");
          return;
        }

      // Disable the form button during request
      $("#paymentForm button[type='submit']").prop("disabled", true);

      // Prepare data
      let userId = localStorage.getItem('userId') || 'guest';
      let paymentData = {
        userId: userId,
        cardName: cardName,
        cardNumber: cardNumber,
        cardExpiry: cardExpiry,
        cardCVC: cardCVC
      };


      $.ajax({
        url: "/api/cart/checkout",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify(paymentData),
        success: function(response){
        // On payment success, clear UI cart and close modal
        $("#paymentModal").hide();
        $("#cartTable tr:gt(0)").remove();
        $("#total").text("Total: $0.00");
        $("#loanResult").text('');
        $("#error").css("color", "green").text("Payment successful! Thank you for your purchase.");
        },
        error: function(xhr){
          $("#paymentError").text("Payment failed. Please check your card or try again.");
        },
        complete: function(){
          $("#paymentForm button[type='submit']").prop("disabled", false);
        }
      });
    });

    });
  </script>
</body>
</html>


